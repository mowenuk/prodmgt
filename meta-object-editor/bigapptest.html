<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Meta-Object & Relationship Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.3.5/justgage.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab { display: inline-block; padding: 10px 20px; margin-right: 5px; cursor: pointer; background: #eee; border-radius: 4px 4px 0 0; }
    .tab.active { background: #fff; border: 1px solid #ccc; border-bottom: none; }
    .tab-content { border: 1px solid #ccc; padding: 20px; border-radius: 0 4px 4px 4px; display: none; }
    .tab-content.active { display: block; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .btn { padding: 6px 12px; cursor: pointer; }
    .btn-primary { background: #007BFF; color: #fff; border: none; }
    .btn-danger { background: #DC3545; color: #fff; border: none; }
    input[type=text], select, textarea { width: 100%; box-sizing: border-box; }
    select[multiple] { height: 80px; }
    input:disabled, select:disabled, textarea:disabled { background: #eee; }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<body>
<h2>Meta-Object & Relationship Editor</h2>
<div class="controls">
  <button class="btn btn-primary" id="saveAllBtn">Save All</button>
</div>
<div class="controls">
  <label for="datasetSelector">Choose dataset:</label>
  <select id="datasetSelector" class="form-select" style="width: auto; display: inline-block;">
    <option value="default">Default</option>
    <option value="togaf">TOGAF</option>
  </select>
  <button class="btn btn-primary" id="reloadDatasetBtn">Reload Dataset</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="typesTab">Object Types</div>
  <div class="tab" data-tab="relsTab">Relationships</div>
  <div class="tab" data-tab="schemaTab">Schema</div>
  <div class="tab" data-tab="previewTab">Preview</div>
</div>

<!-- Object Types -->
<div id="typesTab" class="tab-content active">
  <div class="controls">
    <input type="file" id="typesFile" accept=".csv" />
    <button class="btn btn-primary" id="loadTypesBtn">Load Types</button>
    <button class="btn btn-primary" id="addTypeBtn">Add Type</button>
    <button class="btn btn-primary" id="downloadTypesBtn">Download Types</button>
  </div>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>Description</th><th>System</th><th>Actions</th></tr>
    </thead>
    <tbody id="typesBody"></tbody>
  </table>
</div>

<!-- Relationships -->
<div id="relsTab" class="tab-content">
  <div class="controls">
    <input type="file" id="relsFile" accept=".csv" />
    <button class="btn btn-primary" id="loadRelsBtn">Load Relationships</button>
    <button class="btn btn-primary" id="addRelBtn">Add Relationship</button>
    <button class="btn btn-primary" id="downloadRelsBtn">Download Relationships</button>
  </div>
  <div class="controls">
    <label>Filter From Type:</label>
    <select id="relsFilterSelect"></select>
  </div>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>Reverse Name</th><th>Label</th><th>From</th><th>To</th><th>System</th><th>Actions</th></tr>
    </thead>
    <tbody id="relsBody"></tbody>
  </table>
</div>

<!-- Schema -->
<div id="schemaTab" class="tab-content">
  <div class="controls">
    <input type="file" id="schemaFile" accept=".csv" />
    <button class="btn btn-primary" id="loadSchemaBtn">Load Properties</button>
    <button class="btn btn-primary" id="addSchemaBtn">Add Attribute</button>   <!-- NEW -->
    <button class="btn btn-primary" id="downloadSchemaBtn">Download Properties</button>
    <button class="btn btn-secondary" id="toggleExampleTabBtn">Toggle Example Widgets</button>
  </div>
<div id="exampleWidgetTab" class="mt-4" style="display:none;">
  <h4>Widget &amp; Data Type Examples</h4>
  <div class="row row-cols-1 row-cols-md-2 g-4">

    <!-- Short Text -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Short Text (Text Input)</h5>
          <input type="text" class="form-control" placeholder="Example text">
        </div>
      </div>
    </div>

    <!-- Long Text -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Long Text (Textarea)</h5>
          <textarea class="form-control" rows="3">Example long text</textarea>
        </div>
      </div>
    </div>

    <!-- Integer -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Integer (Spinner)</h5>
          <input type="number" class="form-control" value="42">
        </div>
      </div>
    </div>

    <!-- Date -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Date (Date Picker)</h5>
          <input type="date" class="form-control">
        </div>
      </div>
    </div>

    <!-- Percentage -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Percentage (Progress Bar)</h5>
          <progress class="form-range w-100" value="65" max="100"></progress>
        </div>
      </div>
    </div>

    <!-- Boolean -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Boolean (Checkbox)</h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="booleanExample" checked>
            <label class="form-check-label" for="booleanExample">Enabled</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Slider -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Slider</h5>
          <input type="range" class="form-range" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <!-- Single Select -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Single Select</h5>
          <select class="form-select">
            <option>Option A</option>
            <option selected>Option B</option>
            <option>Option C</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Multi-Select -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Multi-Select</h5>
          <select multiple class="form-select">
            <option selected>Option 1</option>
            <option>Option 2</option>
            <option>Option 3</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Dial Gauge -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Dial Gauge (0–100)</h5>
          <div id="gaugeExample" style="width:200px; height:160px; margin:0 auto;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Initialize the example gauge -->
<script>
  // Ensure Raphael & JustGage are already loaded
  document.addEventListener('DOMContentLoaded', () => {
    try {
      new JustGage({
        id:              'gaugeExample',
        value:           50,
        min:             0,
        max:             100,
        title:           'Example Gauge',
        label:           '',
        pointer:         true,
        gaugeWidthScale: 0.6
      });
    } catch (e) {
      console.error('Failed to initialize example gauge:', e);
    }
  });
</script>


  <table>
    <thead>
 <tr>
  <th>ID</th>
  <th>Name</th>
  <th>Label</th>
  <th>Types</th>
  <th>Data Type</th>
  <th>Widget</th>
    <th>Help</th>
  <th>Options</th>
  <th>Group</th>
  <th>Layout</th>
  <th>System</th>
  <th>Actions</th>
</tr>
    </thead>
    <tbody id="schemaBody"></tbody>
  </table>
</div>

<!-- Preview -->
<div id="previewTab" class="tab-content">
  <div class="controls">
    <label>Select Object Type:</label>
    <select id="previewTypeSelect"></select>
  </div>
  <form id="previewForm"></form>
</div>


<script>
  let schemaRows = [], metaTypes = [], metaRels = [];
  const dataTypeOptions = ['short text','long text','integer','date','percentage','boolean'];
  // map each data type to its allowed widgets
const widgetsByDataType = {
  'short text':   ['text input','search input','email input','url input','tel input','floating label','select', 'single select', 'multi-select'],
  'long text':    ['textarea','rich text','markdown editor','code editor'],
  'integer':      ['spinner','stepper','range slider'],
  'date':         ['date picker','time picker','datetime-local','month picker','week picker'],
  'percentage':   ['progress bar','editable progress bar','dial gauge'],
  'boolean':      ['checkbox','radio group','toggle buttons'],
  // you can add more data types here...
};

// help text for each widget (displayed when user clicks “?”)
// User-focused help text
const widgetHelpText = {
  'range slider':           'User enters min,max,step (e.g. 0,100,10).',
  'stepper':                'User enters min,max,step (e.g. 0,10,1).',
  'radio group':            'Enter choices comma-separated (e.g. High,Medium,Low).',
  'toggle buttons':         'Enter choices comma-separated (e.g. On,Off).',
  'select':                 'Enter choices comma-separated (e.g. Red,Green,Blue).',
  'single select':          'Enter choices comma-separated (e.g. Small,Medium,Large).',
  'multi-select':           'Enter choices comma-separated (e.g. Apple,Banana,Cherry).',
  'editable progress bar':  'Enter initialValue,max (e.g. 50,100).',
  'dial gauge':             'Enter min,max (e.g. 0,360).',
  'text input':             'Enter the default text you want pre-filled (e.g. Specify your name).',
  // everything else:
  'search input':           'No user options needed.',
  'email input':            'No user options needed.',
  'url input':              'No user options needed.',
  'tel input':              'No user options needed.',
  'floating label':         'No user options needed.',
  'textarea':               'No user options needed.',
  'rich text':              'No user options needed.',
  'markdown editor':        'No user options needed.',
  'code editor':            'No user options needed.',
  'spinner':                'No user options needed.',
  'date picker':            'No user options needed.',
  'time picker':            'No user options needed.',
  'datetime-local':         'No user options needed.',
  'month picker':           'No user options needed.',
  'week picker':            'No user options needed.',
  'progress bar':           'No user options needed.',
  'checkbox':               'No user options needed.'
};
  const widgetOptions = ['text input','textarea','spinner','date picker','progress bar','checkbox','slider','select','single select','multi-select'];
  const layoutOptions = [
  'full-width',
  'half-left',
  'half-right',
  'one-third',
  'two-thirds',
  'quarter',
  'three-quarters',
  'inline',
  'auto',
  'hidden'
];
// Only these widgets require the user to supply “options” (e.g. enum values or ranges)
const userOptionWidgets = [
  'text input',
  'range slider',
  'stepper',
  'radio group',
  'toggle buttons',
  'select',
  'single select',
  'multi-select',
  'editable progress bar',
  'dial gauge'
];

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if (tab.dataset.tab === 'previewTab') { updatePreviewTypeSelect(); renderPreviewForm(); }
      if (tab.dataset.tab === 'relsTab') { populateRelsFilter(); renderRels(); }
      if (tab.dataset.tab === 'typesTab') { renderTypes(); }
      if (tab.dataset.tab === 'schemaTab') { renderSchema(); }
    });
  });




    // Schema CRUD
 
function renderSchema() {
  const tbody = document.getElementById('schemaBody');
  tbody.innerHTML = '';

  schemaRows.forEach((r, i) => {
    const tr = document.createElement('tr');

    // --- ID (read-only) ---
    const idTd = document.createElement('td');
    const idIn = document.createElement('input');
    idIn.type = 'text';
    idIn.value = r.id;
    idIn.disabled = true;
    idTd.appendChild(idIn);
    tr.appendChild(idTd);

    // --- Name ---
    const nameTd = document.createElement('td');
    const nameIn = document.createElement('input');
    nameIn.type = 'text';
    nameIn.value = r.name;
    nameIn.onchange = e => r.name = e.target.value;
    nameTd.appendChild(nameIn);
    tr.appendChild(nameTd);

    // --- Label ---
    const labelTd = document.createElement('td');
    const labelIn = document.createElement('input');
    labelIn.type = 'text';
    labelIn.value = r.label;
    labelIn.onchange = e => r.label = e.target.value;
    labelTd.appendChild(labelIn);
    tr.appendChild(labelTd);

    // --- Types (multi-select of loaded metaTypes) ---
    const typesTd = document.createElement('td');
    if (metaTypes.length > 0) {
      const sel = document.createElement('select');
      sel.multiple = true;
      sel.style.width = '100%';
      metaTypes.forEach(mt => {
        const opt = document.createElement('option');
        opt.value = mt.id;
        opt.textContent = mt.name;
        if (r.type_IDs.includes(mt.id)) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = () => {
        r.type_IDs = Array.from(sel.selectedOptions).map(o => o.value);
      };
      typesTd.appendChild(sel);
    } else {
      typesTd.textContent = r.type_IDs.join(',');
    }
    tr.appendChild(typesTd);

    // --- Data Type (single select) ---
    const dtTd = document.createElement('td');
    const dtSel = document.createElement('select');
    dataTypeOptions.forEach(optText => {
      const opt = document.createElement('option');
      opt.value = optText;
      opt.textContent = optText;
      if (r.dataType === optText) opt.selected = true;
      dtSel.appendChild(opt);
    });
    // When dataType changes, update both the model and the widget cell
dtSel.onchange = e => {
  r.dataType = e.target.value;
  renderSchema();   // simplest: redraw the whole table so widget lists update
};
    dtTd.appendChild(dtSel);
    tr.appendChild(dtTd);

// --- Widget (single select) ---
const wTd = document.createElement('td');
const wSel = document.createElement('select');
const allowed = widgetsByDataType[r.dataType] || [];
allowed.forEach(optText => {
  const opt = document.createElement('option');
  opt.value       = optText;
  opt.textContent = optText;
  if (r.widget === optText) opt.selected = true;
  wSel.appendChild(opt);
});
// on change: update the model *and* re-render the whole table
wSel.onchange = e => {
  r.widget = e.target.value;
  renderSchema();    // ← this redraws every row, so Options will now mask/unmask correctly
};
wTd.appendChild(wSel);
tr.appendChild(wTd);

// --- Widget Help (button) ---
const helpTd = document.createElement('td');
const helpBtn = document.createElement('button');
helpBtn.type = 'button';
helpBtn.className = 'btn btn-outline-secondary btn-sm';
helpBtn.textContent = '?';
helpBtn.onclick = () => {
  const help = widgetHelpText[r.widget] || 'No help available for this widget.';
  alert(`${r.widget}:\n\n${help}`);
};
helpTd.appendChild(helpBtn);
tr.appendChild(helpTd);


// --- Options (user-defined only) ---
const optTd = document.createElement('td');
if ( userOptionWidgets.includes(r.widget) ) {
  const optIn = document.createElement('input');
  optIn.type        = 'text';
  optIn.value       = r.options.join(',');
  optIn.placeholder = widgetHelpText[r.widget] || '';
  optIn.onchange    = e => {
    r.options = e.target.value
                  .split(',')
                  .map(s => s.trim())
                  .filter(s => s);
  };
  optTd.appendChild(optIn);
} else {
  optTd.textContent = '—';
}
tr.appendChild(optTd);

    
    
// --- Group ---
const groupTd = document.createElement('td');
const groupIn = document.createElement('input');
groupIn.type = 'text';
groupIn.value = r.group || '';
groupIn.onchange = e => r.group = e.target.value;
groupTd.appendChild(groupIn);
tr.appendChild(groupTd);

// --- Layout ---
const layoutTd = document.createElement('td');
const layoutSel = document.createElement('select');
// new:
layoutOptions.forEach(optText => {
  const opt = document.createElement('option');
  opt.value   = optText;
  opt.textContent = optText;
  if (r.layout === optText) opt.selected = true;
  layoutSel.appendChild(opt);
});

layoutSel.onchange = e => r.layout = e.target.value;
layoutTd.appendChild(layoutSel);
tr.appendChild(layoutTd);

    // --- System (checkbox) ---
    const sysTd = document.createElement('td');
    const sysCb = document.createElement('input');
    sysCb.type = 'checkbox';
    sysCb.checked = r.system;
    sysCb.onchange = e => r.system = e.target.checked;
    sysTd.appendChild(sysCb);
    tr.appendChild(sysTd);

    // --- Actions (Delete) ---
    const actTd = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-danger';
    delBtn.textContent = 'Delete';
    delBtn.onclick = () => { schemaRows.splice(i, 1); renderSchema(); };
    actTd.appendChild(delBtn);
    tr.appendChild(actTd);

    tbody.appendChild(tr);
  });
}

  document.getElementById('loadSchemaBtn').addEventListener('click', () => {
    const file = document.getElementById('schemaFile').files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
complete: res => {
  schemaRows = res.data.map(r => ({
    id:        r.id,
    name:      r.name,
    label:     r.label,
    type_IDs:  (r.type_IDs||'').split(',').map(s=>s.trim()),
    dataType:  r.dataType,
    widget:    r.widget,
    options:   (r.options||'').split(',').map(s=>s.trim()),
    group:     r.group     || '',
    layout:    r.layout    || 'full-width',
    system:    String(r.system||'').toLowerCase()==='true'
  }));
  renderSchema();
}

    });
  });

 document.getElementById('downloadSchemaBtn').addEventListener('click', () => {
  const out = schemaRows.map(r => ({
    id:        r.id,
    name:      r.name,
    label:     r.label,
    type_IDs:  r.type_IDs.join(','),
    dataType:  r.dataType,
    widget:    r.widget,
    options:   r.options.join(','),
    group:     r.group || '',
    layout:    r.layout || 'full-width',
    system:    r.system
  }));
  const csv = Papa.unparse(out, {
    columns: [
      'id','name','label','type_IDs','dataType','widget',
      'options','group','layout','system'
    ]
  });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'meta-object-properties.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
  
  // Add a new, blank attribute
  document.getElementById('addSchemaBtn').addEventListener('click', () => {
    // compute next numeric ID
    const maxId = schemaRows.reduce((m, r) => Math.max(m, parseInt(r.id,10) || 0), 0);
    const nextId = (maxId + 1).toString();
    schemaRows.push({
      id: nextId,
      name: '',
      label: '',
      type_IDs: [],           // no types selected yet
      dataType: dataTypeOptions[0],
      widget: widgetOptions[0],
      options: [],
      system: false
    });
    renderSchema();
  });


  // Preview
function updatePreviewTypeSelect() {
  const sel = document.getElementById('previewTypeSelect');
  if (!sel) return console.error('No #previewTypeSelect found');
  
  // 1) Clear any existing options
  sel.options.length = 0;

  // 2) Populate with metaTypes
  metaTypes.forEach(mt => {
    // The Option() constructor always returns a valid HTMLOptionElement
    const opt = new Option(mt.name, mt.id);
    sel.add(opt);
  });

  // 3) On change, redraw the preview
  sel.onchange = renderPreviewForm;

  // 4) Pick the first value (if any) and render once
  if (sel.options.length) {
    sel.selectedIndex = 0;
    renderPreviewForm();
  }
}
function renderPreviewForm() {
  const typeId = document.getElementById('previewTypeSelect').value;
  const form   = document.getElementById('previewForm');
  form.innerHTML = '';

  // Group attributes by “group”, skipping hidden layouts
  const grouped = {};
  schemaRows.forEach(r => {
    if (!r.type_IDs.includes(typeId) || r.layout === 'hidden') return;
    const grp = r.group || 'Default';
    if (!grouped[grp]) grouped[grp] = [];
    grouped[grp].push(r);
  });

  // Build the accordion
  const accordion = document.createElement('div');
  accordion.className = 'accordion';
  accordion.id        = 'previewAccordion';

  let groupCount = 0;
  Object.entries(grouped).forEach(([groupName, fields]) => {
    const groupId = `group${groupCount++}`;

    // Accordion item & header
    const item   = document.createElement('div');
    item.className = 'accordion-item';

    const header = document.createElement('h2');
    header.className = 'accordion-header';
    const btn = document.createElement('button');
    btn.className = `accordion-button${groupCount>1?' collapsed':''}`;
    btn.type = 'button';
    btn.setAttribute('data-bs-toggle','collapse');
    btn.setAttribute('data-bs-target',`#collapse-${groupId}`);
    btn.innerText = `Group: ${groupName}`;
    header.appendChild(btn);

    // Collapsible body
    const collapse = document.createElement('div');
    collapse.id = `collapse-${groupId}`;
    collapse.className = `accordion-collapse collapse${groupCount===1?' show':''}`;
    collapse.setAttribute('data-bs-parent','#previewAccordion');

    const body = document.createElement('div');
    body.className = 'accordion-body';

    const row = document.createElement('div');
    row.className = 'row g-3';

    // Render each field in this group
    fields.forEach(r => {
      const col = document.createElement('div');
      // Map layout to Bootstrap cols
      switch (r.layout) {
        case 'half-left':
        case 'half-right':
          col.className = 'col-md-6'; break;
        case 'one-third':
          col.className = 'col-md-4'; break;
        case 'two-thirds':
          col.className = 'col-md-8'; break;
        case 'quarter':
          col.className = 'col-md-3'; break;
        case 'three-quarters':
          col.className = 'col-md-9'; break;
        case 'inline':
        case 'auto':
          col.className = 'col-auto'; break;
        default:
          col.className = 'col-12';
      }

      const wrapper = document.createElement('div');
      wrapper.className = r.widget === 'checkbox'
        ? 'form-check form-switch mt-2'
        : 'mb-3';

      const label = document.createElement('label');
      label.className = r.widget === 'checkbox'
        ? 'form-check-label ms-2'
        : 'form-label';
      label.textContent = r.label || r.name;

      let input;

      switch (r.widget) {
        case 'text input':
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          if (r.options[0]) input.value = r.options[0];
          break;

        case 'search input':
        case 'email input':
        case 'url input':
        case 'tel input':
          input = document.createElement('input');
          input.type = r.widget.split(' ')[0];
          input.className = 'form-control';
          break;

        case 'textarea':
          input = document.createElement('textarea');
          input.className = 'form-control';
          break;

        case 'spinner':
          input = document.createElement('input');
          input.type = 'number';
          input.className = 'form-control';
          break;

        case 'stepper': {
          const grp = document.createElement('div');
          grp.className = 'input-group';
          const dec = document.createElement('button');
          dec.className = 'btn btn-outline-secondary';
          dec.type = 'button';
          dec.textContent = '−';
          const inc = document.createElement('button');
          inc.className = 'btn btn-outline-secondary';
          inc.type = 'button';
          inc.textContent = '+';
          const num = document.createElement('input');
          num.type = 'number';
          num.className = 'form-control';
          grp.append(dec, num, inc);
          wrapper.appendChild(label);
          wrapper.appendChild(grp);
          col.appendChild(wrapper);
          row.appendChild(col);
          return;  // skip generic append
        }

        case 'range slider':
          input = document.createElement('input');
          input.type = 'range';
          input.className = 'form-range';
          if (r.options[0]) input.min  = r.options[0];
          if (r.options[1]) input.max  = r.options[1];
          if (r.options[2]) input.step = r.options[2];
          input.value = ((parseFloat(input.min)||0) + (parseFloat(input.max)||100)) / 2;
          break;

        case 'date picker':
          input = document.createElement('input');
          input.type = 'date';
          input.className = 'form-control';
          break;

        case 'time picker':
          input = document.createElement('input');
          input.type = 'time';
          input.className = 'form-control';
          break;

        case 'datetime-local':
        case 'month picker':
        case 'week picker': {
          input = document.createElement('input');
          input.type = r.widget.replace(' picker','').replace('datetime-local','datetime-local');
          input.className = 'form-control';
          break;
        }

        case 'progress bar':
          input = document.createElement('progress');
          input.className = 'form-range w-100';
          input.max = 100;
          input.value = parseFloat(r.options[0]) || 0;
          break;

        case 'checkbox':
          input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'form-check-input';
          wrapper.appendChild(input);
          wrapper.appendChild(label);
          col.appendChild(wrapper);
          row.appendChild(col);
          return;  // skip generic append

        case 'select':
        case 'single select':
          input = document.createElement('select');
          input.className = 'form-select';
          r.options.forEach(o => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = o;
            input.appendChild(opt);
          });
          break;

        case 'multi-select':
          input = document.createElement('select');
          input.className = 'form-select';
          input.multiple = true;
          r.options.forEach(o => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = o;
            input.appendChild(opt);
          });
          break;

        case 'dial gauge': {
          const gaugeDiv = document.createElement('div');
          const gaugeId  = `gauge-${r.id}`;
          gaugeDiv.id     = gaugeId;
          gaugeDiv.style.width  = '200px';
          gaugeDiv.style.height = '160px';
          wrapper.appendChild(label);
          wrapper.appendChild(gaugeDiv);
          col.appendChild(wrapper);
          row.appendChild(col);

          setTimeout(() => {
            try {
              const min = parseFloat(r.options[0]) || 0;
              const max = parseFloat(r.options[1]) || 100;
              const val = (min + max) / 2;
              new JustGage({
                id:              gaugeId,
                value:           val,
                min:             min,
                max:             max,
                title:           r.label || r.name,
                label:           '',
                pointer:         true,
                gaugeWidthScale: 0.6
              });
            } catch (err) {
              console.error(`Gauge init failed for ${gaugeId}:`, err);
            }
          }, 0);

          return;  // skip generic append
        }

        default:
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
      }

      // generic append for non-special cases
      wrapper.appendChild(label);
      wrapper.appendChild(input);
      col.appendChild(wrapper);
      row.appendChild(col);
    });

    body.appendChild(row);
    collapse.appendChild(body);
    item.appendChild(header);
    item.appendChild(collapse);
    accordion.appendChild(item);
  });

  form.appendChild(accordion);
}






  // Types CRUD
  function renderTypes() {
    const tbody = document.getElementById('typesBody'); tbody.innerHTML = '';
    metaTypes.forEach((t,i) => {
      const tr = document.createElement('tr');
      const idTd = document.createElement('td'); const idIn = document.createElement('input'); idIn.value = t.id; idIn.disabled = true; idTd.appendChild(idIn); tr.appendChild(idTd);
      const nameTd = document.createElement('td'); const nameIn = document.createElement('input'); nameIn.value = t.name; nameIn.onchange = e => t.name = e.target.value; nameTd.appendChild(nameIn); tr.appendChild(nameTd);
      const descTd = document.createElement('td'); const descIn = document.createElement('input'); descIn.value = t.description; descIn.onchange = e => t.description = e.target.value; descTd.appendChild(descIn); tr.appendChild(descTd);
      const sysTd = document.createElement('td'); const sysCb = document.createElement('input'); sysCb.type = 'checkbox'; sysCb.checked = t.system; sysCb.onchange = e => t.system = e.target.checked; sysTd.appendChild(sysCb); tr.appendChild(sysTd);
      const actTd = document.createElement('td'); const delBtn = document.createElement('button'); delBtn.className = 'btn btn-danger'; delBtn.textContent = 'Delete'; delBtn.onclick = () => { metaTypes.splice(i,1); renderTypes(); }; actTd.appendChild(delBtn); tr.appendChild(actTd);
      tbody.appendChild(tr);
    });
  }
  document.getElementById('loadTypesBtn').addEventListener('click', () => {
    const f = document.getElementById('typesFile').files[0]; if (!f) return;
    Papa.parse(f,{header:true,skipEmptyLines:true,complete:res=>{ metaTypes = res.data.map(r=>({id:r.id,name:r.name,description:r.description,system:String(r.system||'').toLowerCase()==='true'})); renderTypes(); }});
  });
  document.getElementById('addTypeBtn').addEventListener('click', () => {
    const maxId = metaTypes.reduce((m,t)=>Math.max(m,parseInt(t.id,10)||0),0);
    const nextId = (maxId+1).toString();
    metaTypes.push({ id: nextId, name: '', description: '', system: false });
    renderTypes();
  });
  document.getElementById('downloadTypesBtn').addEventListener('click', () => {
    const csv = Papa.unparse(metaTypes,{columns:['id','name','description','system']});
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'meta-objects.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Relationships CRUD
  function populateRelsFilter() {
    const sel = document.getElementById('relsFilterSelect'); sel.innerHTML = '';
    metaTypes.forEach(mt=>{const o=document.createElement('option');o.value=mt.id;o.textContent=mt.name;sel.appendChild(o);});
    sel.onchange = renderRels;
  }
  function renderRels() {
    const fromId = document.getElementById('relsFilterSelect').value;
    const tbody = document.getElementById('relsBody'); tbody.innerHTML = '';
    metaRels.filter(r=>r.fromMetaObjectID===fromId).forEach((r,i)=>{
      const tr = document.createElement('tr');
      const idTd = document.createElement('td'); idTd.textContent = r.id; tr.appendChild(idTd);
      const nameTd = document.createElement('td'); const nameIn = document.createElement('input'); nameIn.type='text'; nameIn.value=r.name; nameIn.onchange=e=>r.name=e.target.value; nameTd.appendChild(nameIn); tr.appendChild(nameTd);
      const revTd = document.createElement('td'); const revIn=document.createElement('input'); revIn.type='text'; revIn.value=r.reverseName; revIn.onchange=e=>r.reverseName=e.target.value; revTd.appendChild(revIn); tr.appendChild(revTd);
      const lblTd = document.createElement('td'); const lblIn=document.createElement('input'); lblIn.type='text'; lblIn.value=r.label; lblIn.onchange=e=>r.label=e.target.value; lblTd.appendChild(lblIn); tr.appendChild(lblTd);
      const fromTd=document.createElement('td'); fromTd.textContent=r.fromMetaObjectID; tr.appendChild(fromTd);
      const toTd=document.createElement('td'); const toSel=document.createElement('select'); metaTypes.forEach(mt=>{const o=document.createElement('option');o.value=mt.id;o.textContent=mt.name;if(r.toMetaObjectID===mt.id)o.selected=true;toSel.appendChild(o);}); toSel.onchange=e=>r.toMetaObjectID=e.target.value; toTd.appendChild(toSel); tr.appendChild(toTd);
      const sysTd=document.createElement('td'); const sysCb=document.createElement('input'); sysCb.type='checkbox'; sysCb.checked=r.system; sysCb.onchange=e=>r.system=e.target.checked; sysTd.appendChild(sysCb); tr.appendChild(sysTd);
      const actTd=document.createElement('td'); const delBtn=document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.textContent='Delete'; delBtn.onclick=()=>{metaRels.splice(i,1);renderRels();}; actTd.appendChild(delBtn); tr.appendChild(actTd);
      tbody.appendChild(tr);
    });
  }
  document.getElementById('loadRelsBtn').addEventListener('click',()=>{
    const f=document.getElementById('relsFile').files[0];if(!f)return;
    Papa.parse(f,{header:true,skipEmptyLines:true,complete:res=>{metaRels=res.data.map(r=>({id:r.id,name:r.name,reverseName:r.reverseName||r.reversename||'',label:r.label,fromMetaObjectID:r.fromMetaObjectID,toMetaObjectID:r.toMetaObjectID,system:String(r.system||'').toLowerCase()==='true'}));populateRelsFilter();renderRels();}});
  });
  document.getElementById('addRelBtn').addEventListener('click',()=>{
    if(metaTypes.length===0)return alert('Load types first');
    const fromId=document.getElementById('relsFilterSelect').value;
    const maxId=metaRels.reduce((m,r)=>Math.max(m,parseInt(r.id,10)||0),0);
    const nextId=(maxId+1).toString();
    const defaultTo=metaTypes[0].id;
    metaRels.push({id:nextId,name:'',reverseName:'',label:'',fromMetaObjectID:fromId,toMetaObjectID:defaultTo,system:false});
    renderRels();
  });
  document.getElementById('downloadRelsBtn').addEventListener('click',()=>{
    const data=metaRels.map(r=>({id:r.id,name:r.name,reverseName:r.reverseName,label:r.label,fromMetaObjectID:r.fromMetaObjectID,toMetaObjectID:r.toMetaObjectID,system:r.system}));
    const csv=Papa.unparse(data,{columns:['id','name','reverseName','label','fromMetaObjectID','toMetaObjectID','system']});
    const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='rels_meta-objects.csv';a.click();URL.revokeObjectURL(url);
  });
  
  
  
  window.addEventListener('DOMContentLoaded', () => {
  autoLoadCSV('https://raw.githubusercontent.com/mowenuk/prodmgt/main/meta-object-editor/meta-models/meta-objects.csv', loadTypesFromData);
  autoLoadCSV('https://raw.githubusercontent.com/mowenuk/prodmgt/main/meta-object-editor/meta-models/rels_meta-objects.csv', loadRelsFromData);
  autoLoadCSV('https://raw.githubusercontent.com/mowenuk/prodmgt/main/meta-object-editor/meta-models/meta-object-properties.csv', loadSchemaFromData);
});

document.getElementById('saveAllBtn').addEventListener('click', () => {
  saveCSV(metaTypes.map(t => ({
    id: t.id,
    name: t.name,
    description: t.description,
    system: t.system
  })), 'meta-objects.csv', ['id', 'name', 'description', 'system']);

  saveCSV(metaRels.map(r => ({
    id: r.id,
    name: r.name,
    reverseName: r.reverseName,
    label: r.label,
    fromMetaObjectID: r.fromMetaObjectID,
    toMetaObjectID: r.toMetaObjectID,
    system: r.system
  })), 'rels_meta-objects.csv', ['id', 'name', 'reverseName', 'label', 'fromMetaObjectID', 'toMetaObjectID', 'system']);

  saveCSV(schemaRows.map(r => ({
    id: r.id,
    name: r.name,
    label: r.label,
    type_IDs: r.type_IDs.join(','),
    dataType: r.dataType,
    widget: r.widget,
    options: r.options.join(','),
    group: r.group || '',
layout: r.layout || 'full-width',

    system: r.system
  })), 'meta-object-properties.csv', ['id', 'name', 'label', 'type_IDs', 'dataType', 'widget', 'options', 'group', 'layout', 'system']
);
});

function saveCSV(data, filename, columns) {
  const csv = Papa.unparse(data, { columns });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}


function autoLoadCSV(url, callback) {
  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`Failed to fetch ${url}`);
      return response.text();
    })
    .then(text => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data)
      });
    })
    .catch(err => console.error(`Error loading ${url}:`, err));
}

function loadTypesFromData(data) {
  metaTypes = data.map(r => ({
    id: r.id,
    name: r.name,
    description: r.description,
    system: String(r.system || '').toLowerCase() === 'true'
  }));
  renderTypes();
}

function loadRelsFromData(data) {
  metaRels = data.map(r => ({
    id: r.id,
    name: r.name,
    reverseName: r.reverseName || r.reversename || '',
    label: r.label,
    fromMetaObjectID: r.fromMetaObjectID,
    toMetaObjectID: r.toMetaObjectID,
    system: String(r.system || '').toLowerCase() === 'true'
  }));
  populateRelsFilter();
  renderRels();
}

function loadSchemaFromData(data) {
  schemaRows = data.map(r => ({
    id: r.id,
    name: r.name,
    label: r.label,
    type_IDs: (r.type_IDs || '').split(',').map(s => s.trim()),
    dataType: r.dataType,
    widget: r.widget,
    options: (r.options || '').split(',').map(s => s.trim()),
    group: r.group || '',
layout: r.layout || 'full-width',

    system: String(r.system || '').toLowerCase() === 'true'
  }));
  renderSchema();
}

const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/mowenuk/prodmgt/main/';

function getFilename(base, prefix) {
  return `${GITHUB_RAW_BASE}${prefix ? `${prefix}_` : ''}${base}`;
}

function loadDataset(prefix = '') {
  autoLoadCSV(getFilename('meta-objects.csv', prefix), loadTypesFromData);
  autoLoadCSV(getFilename('rels_meta-objects.csv', prefix), loadRelsFromData);
  autoLoadCSV(getFilename('meta-object-properties.csv', prefix), loadSchemaFromData);
}

document.getElementById('reloadDatasetBtn').addEventListener('click', () => {
  const selected = document.getElementById('datasetSelector').value;
  const prefix = selected === 'togaf' ? 'togaf' : '';
  loadDataset(prefix);
});

// Initial load
window.addEventListener('DOMContentLoaded', () => {
  loadDataset(); // loads default by default
});
  
<!-- Add this script to toggle the example tab visibility -->
// cache DOM nodes
const toggleBtn     = document.getElementById('toggleExampleTabBtn');
const exampleTab    = document.getElementById('exampleWidgetTab');

// ensure initial state is hidden + grey
exampleTab.style.display = 'none';
toggleBtn.classList.remove('btn-success');
toggleBtn.classList.add('btn-secondary');

toggleBtn.addEventListener('click', () => {
  // toggle visibility
  const nowHidden = exampleTab.style.display === 'none';
  exampleTab.style.display = nowHidden ? 'block' : 'none';

  // swap button color classes
  if (nowHidden) {
    toggleBtn.classList.remove('btn-secondary');
    toggleBtn.classList.add('btn-success');
  } else {
    toggleBtn.classList.remove('btn-success');
    toggleBtn.classList.add('btn-secondary');
  }
});
</script>
</body>
</html>
