<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Meta-Object & Relationship Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.3.5/justgage.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab { display: inline-block; padding: 10px 20px; margin-right: 5px; cursor: pointer; background: #eee; border-radius: 4px 4px 0 0; }
    .tab.active { background: #fff; border: 1px solid #ccc; border-bottom: none; }
    .tab-content { border: 1px solid #ccc; padding: 20px; border-radius: 0 4px 4px 4px; display: none; }
    .tab-content.active { display: block; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .btn { padding: 6px 12px; cursor: pointer; }
    .btn-primary { background: #007BFF; color: #fff; border: none; }
    .btn-danger { background: #DC3545; color: #fff; border: none; }
    input[type=text], select, textarea { width: 100%; box-sizing: border-box; }
    select[multiple] { height: 80px; }
    input:disabled, select:disabled, textarea:disabled { background: #eee; }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<body>
<h2>Meta-Object & Relationship Editor</h2>
<div class="controls">
  <button class="btn btn-primary" id="saveAllBtn">Save All</button>
</div>
<div class="controls">
  <label for="datasetSelector">Choose dataset:</label>
  <select id="datasetSelector" class="form-select" style="width: auto; display: inline-block;">
    <option value="default">Default</option>
  </select>
  <button class="btn btn-primary" id="reloadDatasetBtn">Reload Dataset</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="typesTab">Object Types</div>
  <div class="tab" data-tab="relsTab">Relationships</div>
  <div class="tab" data-tab="schemaTab">Schema</div>
  <div class="tab" data-tab="previewTab">Preview</div>
</div>

<!-- Object Types -->
<div id="typesTab" class="tab-content active">
  <div class="controls">
    <input type="file" id="typesFile" accept=".csv" />
    <button class="btn btn-primary" id="loadTypesBtn">Load Types</button>
    <button class="btn btn-primary" id="addTypeBtn">Add Type</button>
    <button class="btn btn-primary" id="downloadTypesBtn">Download Types</button>
  </div>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>Description</th><th>System</th><th>Actions</th></tr>
    </thead>
    <tbody id="typesBody"></tbody>
  </table>
</div>

<!-- Relationships -->
<div id="relsTab" class="tab-content">
  <div class="controls">
    <input type="file" id="relsFile" accept=".csv" />
    <button class="btn btn-primary" id="loadRelsBtn">Load Relationships</button>
    <button class="btn btn-primary" id="addRelBtn">Add Relationship</button>
    <button class="btn btn-primary" id="downloadRelsBtn">Download Relationships</button>
  </div>
  <div class="controls">
    <label>Filter From Type:</label>
    <select id="relsFilterSelect"></select>
  </div>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>Reverse Name</th><th>Label</th><th>From</th><th>To</th><th>System</th><th>Actions</th></tr>
    </thead>
    <tbody id="relsBody"></tbody>
  </table>
</div>

<!-- Schema -->
<div id="schemaTab" class="tab-content">
  <div class="controls">
    <input type="file" id="schemaFile" accept=".csv" />
    <button class="btn btn-primary" id="loadSchemaBtn">Load Properties</button>
    <button class="btn btn-primary" id="addSchemaBtn">Add Attribute</button>   <!-- NEW -->
    <button class="btn btn-primary" id="downloadSchemaBtn">Download Properties</button>
    <button class="btn btn-secondary" id="toggleExampleTabBtn">Toggle Example Widgets</button>
  </div>
<div id="exampleWidgetTab" class="mt-4" style="display:none;">
  <h4>Widget &amp; Data Type Examples</h4>
  <div class="row row-cols-1 row-cols-md-2 g-4">

    <!-- Short Text -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Short Text (Text Input)</h5>
          <input type="text" class="form-control" placeholder="Example text">
        </div>
      </div>
    </div>
  <!-- Example: Integer with prefix (Before:£, Amount GBP) -->
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Integer Input (Prefix)</h5>
        <div class="input-group mb-2">
          <span class="input-group-text">£</span>
          <input type="number" class="form-control" placeholder="Amount GBP">
        </div>
        <p class="small text-muted mb-0">
          Options: Before:£, Amount GBP
        </p>
      </div>
    </div>
  </div>

  <!-- Example: Short Text with suffix (After:.com, your email) -->
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Short Text Input (Suffix)</h5>
        <div class="input-group mb-2">
          <input type="text" class="form-control" placeholder="your email">
          <span class="input-group-text">.com</span>
        </div>
        <p class="small text-muted mb-0">
          Options: After:.com, your email
        </p>
      </div>
    </div>
  </div>

    <!-- Long Text -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Long Text (Textarea)</h5>
          <textarea class="form-control" rows="3">Example long text</textarea>
        </div>
      </div>
    </div>

    <!-- Integer -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Integer (Spinner)</h5>
          <input type="number" class="form-control" value="42">
        </div>
      </div>
    </div>

    <!-- Date -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Date (Date Picker)</h5>
          <input type="date" class="form-control">
        </div>
      </div>
    </div>

    <!-- Percentage -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Percentage (Progress Bar)</h5>
          <progress class="form-range w-100" value="65" max="100"></progress>
        </div>
      </div>
    </div>
   <!-- … your existing cards … -->

   <!-- Example: Explicit max (30: Used: danger, 20: Free: success, Max: 80) -->
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Progress Bar (Max = 80)</h5>
        <div class="progress mb-2">
          <div class="progress-bar bg-danger" role="progressbar" style="width:37.5%">
            Used
          </div>
          <div class="progress-bar bg-success" role="progressbar" style="width:25%">
            Free
          </div>
        </div>
        <p class="small text-muted mb-0">
          Options: 30: Used: danger, 20: Free: success, Max: 80
        </p>
      </div>
    </div>
  </div>

  <!-- Example: Default max=100 (40: Ok: info, 60: Busy: warning) -->
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Progress Bar (Default Max)</h5>
        <div class="progress mb-2">
          <div class="progress-bar bg-info" role="progressbar" style="width:40%">
            Ok
          </div>
          <div class="progress-bar bg-warning" role="progressbar" style="width:60%">
            Busy
          </div>
        </div>
        <p class="small text-muted mb-0">
          Options: 40: Ok: info, 60: Busy: warning
        </p>
      </div>
    </div>
  </div>

  <!-- Example: Width-only segments (25, 25, 50: Half) -->
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Progress Bar (Width-only)</h5>
        <div class="progress mb-2">
          <div class="progress-bar" role="progressbar" style="width:25%"></div>
          <div class="progress-bar" role="progressbar" style="width:25%"></div>
          <div class="progress-bar" role="progressbar" style="width:50%">
            Half
          </div>
        </div>
        <p class="small text-muted mb-0">
          Options: 25, 25, 50: Half
        </p>
      </div>
    </div>
  </div>


  <!-- … then close your row and exampleWidgetTab as before … -->


    <!-- Boolean -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Boolean (Checkbox)</h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="booleanExample" checked>
            <label class="form-check-label" for="booleanExample">Enabled</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Slider -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Slider</h5>
          <input type="range" class="form-range" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <!-- Single Select -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Single Select</h5>
          <select class="form-select">
            <option>Option A</option>
            <option selected>Option B</option>
            <option>Option C</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Multi-Select -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Multi-Select</h5>
          <select multiple class="form-select">
            <option selected>Option 1</option>
            <option>Option 2</option>
            <option>Option 3</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Dial Gauge -->
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Dial Gauge (0–100)</h5>
          <div id="gaugeExample" style="width:200px; height:160px; margin:0 auto;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Initialize the example gauge -->
<script>
  // Ensure Raphael & JustGage are already loaded
  document.addEventListener('DOMContentLoaded', () => {
    try {
      new JustGage({
        id:              'gaugeExample',
        value:           50,
        min:             0,
        max:             100,
        title:           'Example Gauge',
        label:           '',
        pointer:         true,
        gaugeWidthScale: 0.6
      });
    } catch (e) {
      console.error('Failed to initialize example gauge:', e);
    }
  });
</script>


  <table>
    <thead>
 <tr>
  <th>ID</th>
  <th>Name</th>
  <th>Label</th>
  <th>Types</th>
  <th>Data Type</th>
  <th>Widget</th>
    <th>Help</th>
  <th>Options</th>
  <th>Group</th>
  <th>Layout</th>
  <th>System</th>
  <th>Actions</th>
</tr>
    </thead>
    <tbody id="schemaBody"></tbody>
  </table>
</div>

<!-- Preview -->
<div id="previewTab" class="tab-content">
  <div class="controls">
    <label>Select Object Type:</label>
    <select id="previewTypeSelect"></select>
  </div>
  <form id="previewForm"></form>
</div>


<script>
  // ── GLOBAL STATE & CONSTANTS ─────────────────────────────────────────
  const quillEditors = {};

  const BS_COLOR_MAP = {
    primary:   'primary',   secondary: 'secondary',
    success:   'success',   danger:    'danger',
    warning:   'warning',   info:      'info',
    light:     'light',     dark:      'dark',
    blue:      'primary',   grey:      'secondary',
    gray:      'secondary', green:     'success',
    red:       'danger',    yellow:    'warning',
    teal:      'info',      white:     'light',
    black:     'dark'
  };

  let metaTypes   = [],
      metaRels    = [],
      schemaRows  = [];

  const dataTypeOptions = ['short text','long text','integer','date','percentage','boolean', 'formula'];

  const widgetsByDataType = {
    'short text':   ['text input','select','single select','multi-select'],
    'long text':    ['textarea','rich text'],
    'integer':      ['text input','spinner','stepper','range slider'],
    'date':         ['date picker','time picker','month picker','week picker'],
    'percentage':   ['progress bar','editable progress bar','dial gauge'],
    'boolean':      ['checkbox','radio group','toggle buttons'],
    'formula':      ['formula editor']
  };
  const widgetHelpText = {
    'text input': 'For prefix/suffix use "Before:symbol, placeholder" or "After:symbol, placeholder".',
    'spinner':    'For prefix/suffix use "Before:symbol, placeholder" or "After:symbol, placeholder".',
    'range slider': 'Enter min,max,step (e.g. 0,100,10).',
    'stepper':      'Enter min,max,step (e.g. 0,10,1).',
    'radio group':  'Enter choices comma-separated (e.g. High,Medium,Low).',
    'toggle buttons': 'Enter choices comma-separated (e.g. On,Off).',
    'select':        'Enter choices comma-separated (e.g. Red,Green,Blue).',
    'single select': 'Enter choices comma-separated (e.g. Small,Medium,Large).',
    'multi-select':  'Enter choices comma-separated (e.g. Apple,Banana,Cherry).',
    'progress bar':  'Enter "value:Label:Color" segments + optional "Max:N".',
    'editable progress bar': 'Enter initialValue,max (e.g. 50,100).',
    'dial gauge':   'Enter min,max (e.g. 0,360).',
    'rich text':    'Quill editor; plain text is saved in CSV.',
  };
  const userOptionWidgets = [
    'text input','spinner','range slider','stepper',
    'radio group','toggle buttons','select','single select',
    'multi-select','editable progress bar','dial gauge',
    'progress bar'
  ];
  const layoutOptions = [
    'full-width','half-left','half-right','one-third','two-thirds',
    'quarter','three-quarters','inline','auto','hidden'
  ];

  // ── CSV SAVE HELPER ─────────────────────────────────────────────────
  function saveCSV(data, filename, columns) {
    const csv  = Papa.unparse(data, { columns });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ── autoLoadCSV & dataset loading ────────────────────────────────────


// ─────────── Config ────────────
const GITHUB_RAW_BASE = 
  'https://raw.githubusercontent.com/mowenuk/prodmgt/main/';

let metaModels = [];

// ────────── CSV Helper ──────────
function autoLoadCSV(url, callback) {
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error(`fetch ${url} → ${res.status}`);
      return res.text();
    })
    .then(txt => Papa.parse(txt, {
      header: true,
      skipEmptyLines: true,
      complete: result => callback(result.data)
    }))
    .catch(err => console.error('CSV load error:', err));
}

// ──────── Build File URL ────────
function getFilename(base, prefix = '') {
  // prefix *already* includes any underscore, e.g. '' or 'togaf_'
  return `${GITHUB_RAW_BASE}meta-models/${prefix}${base}`;
}

// ─────── Load the 3 CSVs ────────
function loadDataset(prefix = '') {
  autoLoadCSV(
    getFilename('meta-objects.csv', prefix),
    loadTypesFromData
  );
  autoLoadCSV(
    getFilename('rels_meta-objects.csv', prefix),
    loadRelsFromData
  );
  autoLoadCSV(
    getFilename('meta-object-properties.csv', prefix),
    loadSchemaFromData
  );
}

// ─── Populate dropdown from meta-models.csv ───
function loadMetaModelsFromData(data) {
  metaModels = data.map(r => ({
    prefix:      r.Prefix      || '',               // '' or 'togaf_'
    name:        r.name        || r.Name    || '',
    description: r.description || ''
  }));

  const sel = document.getElementById('datasetSelector');
  sel.innerHTML = '';

  metaModels.forEach(mm => {
    const label = mm.description
      ? `${mm.name} – ${mm.description}`
      : mm.name;
    sel.appendChild(new Option(label, mm.prefix));
  });

  // When you change the dropdown, reload automatically
  sel.addEventListener('change', () => {
    loadDataset(sel.value);
  });

  // Also wire the Reload button
  document.getElementById('reloadDatasetBtn').onclick = () => {
    loadDataset(sel.value);
  };

  // Kick-off: load the first metamodel by default
  if (metaModels.length) {
    sel.selectedIndex = 0;
    loadDataset(metaModels[0].prefix);
  }
}

// ─────── Initial entrypoint ───────
window.addEventListener('DOMContentLoaded', () => {
  autoLoadCSV(
    `${GITHUB_RAW_BASE}meta-models/meta-models.csv`,
    loadMetaModelsFromData
  );
});


  // ── TYPE CRUD ───────────────────────────────────────────────────────
  function renderTypes() {
    const tbody = document.getElementById('typesBody');
    tbody.innerHTML = '';
    metaTypes.forEach((t,i) => {
      const tr = document.createElement('tr');
      // ID
      const idTd = document.createElement('td');
      const idIn = document.createElement('input');
      idIn.value = t.id; idIn.disabled = true;
      idTd.appendChild(idIn); tr.appendChild(idTd);
      // Name
      const nmTd = document.createElement('td');
      const nmIn = document.createElement('input');
      nmIn.value = t.name; nmIn.onchange = e => t.name = e.target.value;
      nmTd.appendChild(nmIn); tr.appendChild(nmTd);
      // Description
      const dsTd = document.createElement('td');
      const dsIn = document.createElement('input');
      dsIn.value = t.description; dsIn.onchange = e => t.description = e.target.value;
      dsTd.appendChild(dsIn); tr.appendChild(dsTd);
      // System
      const syTd = document.createElement('td');
      const syCb = document.createElement('input');
      syCb.type = 'checkbox'; syCb.checked = t.system;
      syCb.onchange = e => t.system = e.target.checked;
      syTd.appendChild(syCb); tr.appendChild(syTd);
      // Actions
      const acTd = document.createElement('td');
      const del = document.createElement('button');
      del.className = 'btn btn-danger'; del.textContent = 'Delete';
      del.onclick = () => { metaTypes.splice(i,1); renderTypes(); };
      acTd.appendChild(del); tr.appendChild(acTd);

      tbody.appendChild(tr);
    });
  }
  document.getElementById('loadTypesBtn').addEventListener('click', () => {
    const f = document.getElementById('typesFile').files[0];
    if (!f) return;
    Papa.parse(f,{ header:true, skipEmptyLines:true, complete:res => {
      metaTypes = res.data.map(r => ({
        id: r.id,
        name: r.name,
        description: r.description,
        system: String(r.system||'').toLowerCase()==='true'
      }));
      renderTypes();
    }});
  });
  document.getElementById('addTypeBtn').addEventListener('click', () => {
    const maxId = metaTypes.reduce((m,t)=>Math.max(m,parseInt(t.id)||0),0);
    metaTypes.push({ id:String(maxId+1), name:'', description:'', system:false });
    renderTypes();
  });
  document.getElementById('downloadTypesBtn').addEventListener('click', () => {
    saveCSV(metaTypes, 'meta-objects.csv', ['id','name','description','system']);
  });
  function loadTypesFromData(data) {
    metaTypes = data.map(r => ({
      id: r.id,
      name: r.name,
      description: r.description,
      system: String(r.system||'').toLowerCase()==='true'
    }));
    renderTypes();
  }

  // ── RELATIONSHIPS CRUD ─────────────────────────────────────────────────
  function populateRelsFilter() {
    const sel = document.getElementById('relsFilterSelect');
    sel.innerHTML = '';
    metaTypes.forEach(mt => sel.appendChild(new Option(mt.name,mt.id)));
    sel.onchange = renderRels;
  }
  function renderRels() {
    const fromId = document.getElementById('relsFilterSelect').value;
    const tbody = document.getElementById('relsBody');
    tbody.innerHTML = '';
    metaRels.filter(r=>r.fromMetaObjectID===fromId).forEach((r,i) => {
      const tr = document.createElement('tr');
      // ID
      const idTd = document.createElement('td');
      idTd.textContent = r.id; tr.appendChild(idTd);
      // Name
      const nmTd = document.createElement('td');
      const nmIn = document.createElement('input');
      nmIn.value = r.name; nmIn.onchange = e=>r.name=e.target.value;
      nmTd.appendChild(nmIn); tr.appendChild(nmTd);
      // Reverse Name
      const rvTd = document.createElement('td');
      const rvIn = document.createElement('input');
      rvIn.value = r.reverseName; rvIn.onchange = e=>r.reverseName=e.target.value;
      rvTd.appendChild(rvIn); tr.appendChild(rvTd);
      // Label
      const lbTd = document.createElement('td');
      const lbIn = document.createElement('input');
      lbIn.value = r.label; lbIn.onchange = e=>r.label=e.target.value;
      lbTd.appendChild(lbIn); tr.appendChild(lbTd);
      // From
      tr.appendChild(Object.assign(document.createElement('td'),{textContent:r.fromMetaObjectID}));
      // To
      const toTd = document.createElement('td');
      const toSel = document.createElement('select');
      metaTypes.forEach(mt => {
        const o = new Option(mt.name,mt.id,false,r.toMetaObjectID===mt.id);
        toSel.appendChild(o);
      });
      toSel.onchange = e=>r.toMetaObjectID=e.target.value;
      toTd.appendChild(toSel); tr.appendChild(toTd);
      // System
      const syTd2 = document.createElement('td');
      const syCb2 = document.createElement('input');
      syCb2.type='checkbox'; syCb2.checked=r.system;
      syCb2.onchange=e=>r.system=e.target.checked;
      syTd2.appendChild(syCb2); tr.appendChild(syTd2);
      // Actions
      const acTd2 = document.createElement('td');
      const del2 = document.createElement('button');
      del2.className='btn btn-danger'; del2.textContent='Delete';
      del2.onclick=()=>{ metaRels.splice(i,1); renderRels(); };
      acTd2.appendChild(del2); tr.appendChild(acTd2);

      tbody.appendChild(tr);
    });
  }
  document.getElementById('loadRelsBtn').addEventListener('click', () => {
    const f = document.getElementById('relsFile').files[0];
    if (!f) return;
    Papa.parse(f,{ header:true, skipEmptyLines:true, complete:res => {
      metaRels = res.data.map(r=>({
        id: r.id,
        name: r.name,
        reverseName: r.reverseName||r.reversename||'',
        label: r.label,
        fromMetaObjectID: r.fromMetaObjectID,
        toMetaObjectID: r.toMetaObjectID,
        system: String(r.system||'').toLowerCase()==='true'
      }));
      populateRelsFilter();
      renderRels();
    }});
  });
  document.getElementById('addRelBtn').addEventListener('click', () => {
    if (!metaTypes.length) return alert('Load types first');
    const fromId = document.getElementById('relsFilterSelect').value;
    const maxId = metaRels.reduce((m,r)=>Math.max(m,parseInt(r.id)||0),0);
    metaRels.push({
      id: String(maxId+1), name:'', reverseName:'', label:'',
      fromMetaObjectID: fromId,
      toMetaObjectID:   metaTypes[0].id,
      system: false
    });
    renderRels();
  });
  document.getElementById('downloadRelsBtn').addEventListener('click', () => {
    const out = metaRels.map(r=>({
      id: r.id, name: r.name, reverseName: r.reverseName,
      label: r.label, fromMetaObjectID: r.fromMetaObjectID,
      toMetaObjectID: r.toMetaObjectID, system: r.system
    }));
    saveCSV(out,'rels_meta-objects.csv',[
      'id','name','reverseName','label',
      'fromMetaObjectID','toMetaObjectID','system'
    ]);
  });
  function loadRelsFromData(data) {
    metaRels = data.map(r=>({
      id: r.id, name: r.name,
      reverseName: r.reverseName||r.reversename||'',
      label: r.label, fromMetaObjectID: r.fromMetaObjectID,
      toMetaObjectID: r.toMetaObjectID,
      system: String(r.system||'').toLowerCase()==='true'
    }));
    populateRelsFilter();
    renderRels();
  }

  // ── SCHEMA: LOAD, RENDER, EDIT, SAVE ─────────────────────────────────
 function loadSchemaFromData(data) {
  schemaRows = data.map(r => ({
    id:        r.id,
    name:      r.name,
    label:     r.label,
    type_IDs:  (r.type_IDs || '').split(',').map(s => s.trim()),
    dataType:  r.dataType,
    widget:    r.widget,
    options:   // split the CSV cell into an array for **all** widgets
      (r.options || '')
        .split(',')
        .map(s => s.trim())
        .filter(s => s !== ''),
    group:     r.group || '',
    layout:    r.layout || 'full-width',
    system:    String(r.system || '').toLowerCase() === 'true'
  }));
  renderSchema();
}
  document.getElementById('loadSchemaBtn').addEventListener('click', () => {
    const f = document.getElementById('schemaFile').files[0];
    if (!f) return;
    Papa.parse(f,{ header:true, skipEmptyLines:true, complete:res => {
      loadSchemaFromData(res.data);
    }});
  });
function renderSchema() {
  const tbody = document.getElementById('schemaBody');
  tbody.innerHTML = '';

  schemaRows.forEach((r, i) => {
    const tr = document.createElement('tr');
    const isSystem = Boolean(r.system);
    // ───── ID ─────────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = 'text'; inp.value = r.id; inp.disabled = true;
      td.appendChild(inp);
      tr.appendChild(td);
    })();

    // ───── Name ───────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = 'text'; inp.value = r.name;
      inp.disabled = isSystem;                 // ← disable if system
      inp.addEventListener('change', e => r.name = e.target.value);
      td.appendChild(inp);
      tr.appendChild(td);
    })();

    // ───── Label ──────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = 'text'; inp.value = r.label;
      inp.disabled = isSystem;                // ← disable if system
      inp.addEventListener('change', e => r.label = e.target.value);
      td.appendChild(inp);
      tr.appendChild(td);
    })();

    // ───── Types (multi) ──────────────────────────
    (() => {
      const td = document.createElement('td');
      if (metaTypes.length) {
        const sel = document.createElement('select');
        sel.multiple = true; sel.style.width = '100%';
        sel.disabled = isSystem;                   // ← disable if system
        metaTypes.forEach(mt => {
          const o = new Option(mt.name, mt.id);
          o.selected = r.type_IDs.includes(mt.id);
          sel.appendChild(o);
        });
        sel.addEventListener('change', () => {
          r.type_IDs = Array.from(sel.selectedOptions).map(o => o.value);
        });
        td.appendChild(sel);
      } else {
        td.textContent = r.type_IDs.join(',');
      }
      tr.appendChild(td);
    })();

    // ───── DataType ───────────────────────────────
    (() => {
      const td = document.createElement('td');
      const sel = document.createElement('select');
      sel.disabled = isSystem;                  // ← disable if system
      dataTypeOptions.forEach(opt => {
        const o = new Option(opt, opt);
        o.selected = r.dataType === opt;
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => {
        r.dataType = sel.value;
        // reset widget to first for this type
        r.widget = widgetsByDataType[r.dataType][0];
        renderSchema();
      });
      td.appendChild(sel);
      tr.appendChild(td);
    })();

    // ───── Widget ──────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const sel = document.createElement('select');
      sel.disabled = isSystem;                   // ← disable if system
      widgetsByDataType[r.dataType].forEach(opt => {
        const o = new Option(opt, opt);
        o.selected = r.widget === opt;
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => {
        r.widget = sel.value;
        // do NOT clear r.options here
        renderSchema();
      });
      td.appendChild(sel);
      tr.appendChild(td);
    })();

    // ───── Help ────────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary btn-sm';
      btn.textContent = '?';
      btn.disabled = isSystem;                // ← disable if system
      btn.addEventListener('click', () => {
        alert(`${r.widget}:\n\n${widgetHelpText[r.widget] || 'No help.'}`);
      });
      td.appendChild(btn);
      tr.appendChild(td);
    })();

    // ───── Options ─────────────────────────────────
    (() => {
      const optTd = document.createElement('td');

      if (r.widget === 'formula editor') {
        // --- Auto‐init options once ---
        const numericFields = schemaRows.filter(f =>
          ['integer','date','percentage'].includes(f.dataType)
        ).map(f => f.id);
        if (!r.options || r.options.length !== 3) {
          r.options = [
            numericFields[0] || '',   // Field A
            '+',                      // default operator
            numericFields[1] || numericFields[0] || ''
          ];
        }

        // Now build your three dropdowns...
        const candidates = schemaRows.filter(f =>
          ['integer','date','percentage'].includes(f.dataType)
        );
        // Field A
        const fldA = document.createElement('select');
        fldA.className = 'form-select form-select-sm mb-1';
        candidates.forEach(f => {
          const o = new Option(f.label||f.name, f.id);
          if (r.options[0] === f.id) o.selected = true;
          fldA.appendChild(o);
        });
        fldA.onchange = () => r.options[0] = fldA.value;
        optTd.appendChild(fldA);

        // Operator
        const op = document.createElement('select');
        op.className = 'form-select form-select-sm mb-1';
        ['+','-','*','/'].forEach(sym => {
          const o = new Option(sym, sym);
          if (r.options[1] === sym) o.selected = true;
          op.appendChild(o);
        });
        op.onchange = () => r.options[1] = op.value;
        optTd.appendChild(op);

        // Field B
        const fldB = document.createElement('select');
        fldB.className = 'form-select form-select-sm';
        candidates.forEach(f => {
          const o = new Option(f.label||f.name, f.id);
          if (r.options[2] === f.id) o.selected = true;
          fldB.appendChild(o);
        });
        fldB.onchange = () => r.options[2] = fldB.value;
        optTd.appendChild(fldB);
      } else if (userOptionWidgets.includes(r.widget)) {
        // text input for comma-separated options
        const optIn = document.createElement('input');
        optIn.type        = 'text';
        optIn.className   = 'form-control form-control-sm';
        optIn.value       = (r.options || []).join(',');
        optIn.placeholder = widgetHelpText[r.widget] || '';
        optIn.disabled = isSystem;                 // ← disable if system
        optIn.addEventListener('change', e => {
          r.options = e.target.value
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s);
        });
        optTd.appendChild(optIn);

        // inline help text
        const hint = document.createElement('div');
        hint.className   = 'form-text text-muted small';
        hint.textContent = widgetHelpText[r.widget] || '';
        optTd.appendChild(hint);
      } else {
        // no options for this widget
        optTd.textContent = '—';
      }
      tr.appendChild(optTd);
    })();

    // ───── Group ────────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type  = 'text';
      inp.value = r.group;
      inp.disabled = isSystem;                // ← disable if system
      inp.addEventListener('change', e => { r.group = e.target.value; });
      td.appendChild(inp);
      tr.appendChild(td);
    })();

    // ───── Layout ───────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const sel = document.createElement('select');
      sel.disabled = isSystem;               // ← disable if system
      layoutOptions.forEach(opt => {
        const o = new Option(opt, opt);
        o.selected = r.layout === opt;
        sel.appendChild(o);
      });
      sel.addEventListener('change', e => { r.layout = sel.value; });
      td.appendChild(sel);
      tr.appendChild(td);
    })();

    // ───── System ───────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = r.system;
      cb.addEventListener('change', e => { r.system = cb.checked; });
      td.appendChild(cb);
      tr.appendChild(td);
    })();

    // ───── Actions ──────────────────────────────────
    (() => {
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'btn btn-danger';
      btn.textContent = 'Delete';
      btn.disabled = isSystem;                 // ← disable if system
      btn.addEventListener('click', () => {
        schemaRows.splice(i, 1);
        renderSchema();
      });
      td.appendChild(btn);
      tr.appendChild(td);
    })();

    tbody.appendChild(tr);
  });
}


  document.getElementById('downloadSchemaBtn').addEventListener('click', () => {
    schemaRows.forEach(r => {
      if (r.widget==='rich text' && quillEditors[r.id]) {
        r.options = [ quillEditors[r.id].getText().trim() ];
      }
    });
    const out = schemaRows.map(r=>({
      id:        r.id,      name:     r.name,
      label:     r.label,   type_IDs: r.type_IDs.join(','),
      dataType:  r.dataType, widget:   r.widget,
      options:   r.options.join(','), group:    r.group,
      layout:    r.layout,  system:   r.system
    }));
    saveCSV(out,'meta-object-properties.csv',[
      'id','name','label','type_IDs',
      'dataType','widget','options','group','layout','system'
    ]);
  });
  document.getElementById('addSchemaBtn').addEventListener('click', () => {
    const maxId = schemaRows.reduce((m,r)=>Math.max(m,parseInt(r.id)||0),0);
    schemaRows.push({
      id: String(maxId+1),
      name:'', label:'', type_IDs:[], dataType:dataTypeOptions[0],
      widget: widgetsByDataType[dataTypeOptions[0]][0],
      options:[], group:'', layout:'full-width', system:false
    });
    renderSchema();
  });

  // ── TAB SWITCHING ────────────────────────────────────────────────────
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if (tab.dataset.tab==='typesTab') renderTypes();
      if (tab.dataset.tab==='relsTab')  { populateRelsFilter(); renderRels(); }
      if (tab.dataset.tab==='schemaTab') renderSchema();
      if (tab.dataset.tab==='previewTab') { updatePreviewTypeSelect(); renderPreviewForm(); }
    });
  });

  // ── PREVIEW ──────────────────────────────────────────────────────────
  function updatePreviewTypeSelect() {
    const sel = document.getElementById('previewTypeSelect');
    sel.innerHTML = '';
    metaTypes.forEach(mt => sel.appendChild(new Option(mt.name,mt.id)));
    sel.onchange = renderPreviewForm;
    if (sel.options.length) { sel.selectedIndex=0; renderPreviewForm(); }
  }
// ─── Full renderPreviewForm() ──────────────────────────────
function renderPreviewForm() {
  const typeId = document.getElementById('previewTypeSelect').value;
  const form   = document.getElementById('previewForm');
  form.innerHTML = '';

  // ─── 1) Header: meta-type name + ID ─────────────────────────────
  const mt = metaTypes.find(m => m.id === typeId) || {};
  const headerDiv = document.createElement('div');
  headerDiv.className = 'mb-4';
  const titleEl = document.createElement('h4');
  titleEl.className = 'd-flex align-items-baseline';
  titleEl.appendChild(document.createTextNode(mt.name || ''));
  const idEl = document.createElement('small');
  idEl.className = 'text-secondary ms-2';
  idEl.textContent = `ID: ${mt.id || ''}`;
  titleEl.appendChild(idEl);
  headerDiv.appendChild(titleEl);
  form.appendChild(headerDiv);

  // ─── 2) Grouping (skip id & object_type) ────────────────────────
  const grouped = {};
  schemaRows.forEach(r => {
    if (r.name === 'id' || r.name === 'object_type') return;
    if (!r.type_IDs.includes(typeId) || r.layout === 'hidden') return;
    const grp = r.group || 'Default';
    (grouped[grp] = grouped[grp] || []).push(r);
  });

  // ─── 3) Build the accordion ─────────────────────────────────────
  const accordion = document.createElement('div');
  accordion.className = 'accordion';
  accordion.id        = 'previewAccordion';

  Object.entries(grouped).forEach(([groupName, fields], gIdx) => {
    const groupId  = `group${gIdx}`;
    const onlyOne  = fields.length === 1;

    // 3a) Accordion item + header
    const item = document.createElement('div');
    item.className = 'accordion-item';

    const hdr = document.createElement('h2');
    hdr.className = 'accordion-header';
    const btn = document.createElement('button');
    btn.className = `accordion-button${gIdx > 0 ? ' collapsed' : ''}`;
    btn.type = 'button';
    btn.setAttribute('data-bs-toggle', 'collapse');
    btn.setAttribute('data-bs-target', `#collapse-${groupId}`);
    btn.textContent = groupName;
    hdr.appendChild(btn);
    item.appendChild(hdr);

    // 3b) Collapsible body
    const collapse = document.createElement('div');
    collapse.id = `collapse-${groupId}`;
    collapse.className = `accordion-collapse collapse${gIdx === 0 ? ' show' : ''}`;
    collapse.setAttribute('data-bs-parent', '#previewAccordion');

    const body = document.createElement('div');
    body.className = 'accordion-body';
    const row  = document.createElement('div');
    row.className = 'row g-3';

    // 3c) Fields loop
    fields.forEach(r => {
      const col = document.createElement('div');
      // layout
      const layoutKey = onlyOne ? 'full-width' : r.layout;
      switch (layoutKey) {
        case 'half-left':
        case 'half-right':        col.className = 'col-md-6'; break;
        case 'one-third':         col.className = 'col-md-4'; break;
        case 'two-thirds':        col.className = 'col-md-8'; break;
        case 'quarter':           col.className = 'col-md-3'; break;
        case 'three-quarters':    col.className = 'col-md-9'; break;
        case 'inline':
        case 'auto':              col.className = 'col-auto'; break;
        default:                  col.className = 'col-12';
      }

      const wrap = document.createElement('div');
      wrap.className = (r.widget === 'checkbox')
        ? 'form-check form-switch mt-2'
        : 'mb-3';

      // ───────────── Formula editor branch ─────────────────────
      if (r.widget === 'formula editor') {
        // label
        const lbl = document.createElement('label');
        lbl.className = 'form-label';
        lbl.textContent = r.label || r.name;
        wrap.appendChild(lbl);
       // 2) Help‐text suffix showing the formula definition
        const [fldA, op, fldB] = r.options;
        // look up the human names for each field
        const nameA = schemaRows.find(f => f.id === fldA)?.label || fldA;
        const nameB = schemaRows.find(f => f.id === fldB)?.label || fldB;
        const help = document.createElement('small');
        help.className = 'form-text text-muted';
        help.textContent = `(${nameA} ${op} ${nameB})`;
        wrap.appendChild(help);
        // output
        const out = document.createElement('div');
        out.id = `formula-${r.id}`;
        out.className = 'form-control-plaintext';
        wrap.appendChild(out);

        col.appendChild(wrap);
        row.appendChild(col);
        // skip the rest
        return;
      }

      // ─── Non-formula: generic label (unless checkbox) ───────────
      if (r.widget !== 'checkbox') {
        const lbl = document.createElement('label');
        lbl.className = 'form-label';
        lbl.textContent = r.label || r.name;
        wrap.appendChild(lbl);
      }

      // ─── Build the correct input/control ────────────────────────
      let inputEl;
      switch (r.widget) {
        case 'text input':
          inputEl = document.createElement('input');
          inputEl.type = 'text';
          inputEl.className = 'form-control';
          if (r.options[0]) inputEl.value = r.options[0];
          break;

        case 'spinner':
          inputEl = document.createElement('input');
          inputEl.type = 'number';
          inputEl.className = 'form-control';
          if (r.options[0]) inputEl.value = r.options[0];
          break;

        case 'date picker':
          inputEl = document.createElement('input');
          inputEl.type = 'date';
          inputEl.className = 'form-control';
          break;

        case 'checkbox':
          inputEl = document.createElement('input');
          inputEl.type = 'checkbox';
          inputEl.className = 'form-check-input';
          wrap.appendChild(inputEl);
          const chkLbl = document.createElement('label');
          chkLbl.className = 'form-check-label ms-2';
          chkLbl.textContent = r.label || r.name;
          wrap.appendChild(chkLbl);
          break;

        case 'single select':
        case 'select':
          inputEl = document.createElement('select');
          inputEl.className = 'form-select';
          r.options.forEach(optText => {
            inputEl.appendChild(new Option(optText, optText));
          });
          break;

        case 'multi-select':
          inputEl = document.createElement('select');
          inputEl.className = 'form-select';
          inputEl.multiple = true;
          r.options.forEach(optText => {
            const o = new Option(optText, optText);
            o.selected = true;
            inputEl.appendChild(o);
          });
          break;

        // … handle other widget types here as needed …

        default:
          inputEl = document.createElement('input');
          inputEl.type = 'text';
          inputEl.className = 'form-control';
      }

      // every non-formula input needs an ID for formula listeners
      if (inputEl) {
        inputEl.id = `input-${r.id}`;
        wrap.appendChild(inputEl);
      }

      col.appendChild(wrap);
      row.appendChild(col);
    });

    body.appendChild(row);
    collapse.appendChild(body);
    item.appendChild(collapse);
    accordion.appendChild(item);
  });

  form.appendChild(accordion);

  // ─── 4) Wire & compute formulas ───────────────────────────────
  attachFormulaListeners();
  evaluateAllFormulas();
}


  // ── SAVE ALL BUTTON ─────────────────────────────────────────────────
  document.getElementById('saveAllBtn').addEventListener('click', () => {
    // Types
    saveCSV(metaTypes,'meta-objects.csv',['id','name','description','system']);
    // Rels
    saveCSV(metaRels.map(r=>({
      id:r.id,name:r.name,reverseName:r.reverseName,
      label:r.label,fromMetaObjectID:r.fromMetaObjectID,
      toMetaObjectID:r.toMetaObjectID,system:r.system
    })), 'rels_meta-objects.csv',[
      'id','name','reverseName','label',
      'fromMetaObjectID','toMetaObjectID','system'
    ]);
    // Schema
    schemaRows.forEach(r => {
      if (r.widget==='rich text'&&quillEditors[r.id]) {
        r.options=[quillEditors[r.id].getText().trim()];
      }
    });
    saveCSV(schemaRows.map(r=>({
      id:r.id,name:r.name,label:r.label,
      type_IDs:r.type_IDs.join(','),
      dataType:r.dataType,widget:r.widget,
      options:r.options.join(','),group:r.group,
      layout:r.layout,system:r.system
    })), 'meta-object-properties.csv',[
      'id','name','label','type_IDs',
      'dataType','widget','options','group','layout','system'
    ]);
  });

  // ── EXAMPLE TAB TOGGLE ────────────────────────────────────────────────
  const toggleBtn  = document.getElementById('toggleExampleTabBtn');
  const exampleTab = document.getElementById('exampleWidgetTab');
  exampleTab.style.display = 'none';
  toggleBtn.classList.remove('btn-success');
  toggleBtn.classList.add('btn-secondary');
  toggleBtn.addEventListener('click', () => {
    const hidden = exampleTab.style.display==='none';
    exampleTab.style.display = hidden?'block':'none';
    toggleBtn.classList.toggle('btn-success', hidden);
    toggleBtn.classList.toggle('btn-secondary', !hidden);
  });

// Re‐evaluate all formula fields, but only if the output node exists
function evaluateAllFormulas() {
  schemaRows
    .filter(r => r.widget === 'formula editor')
    .forEach(r => {
      const [fldA, op, fldB] = r.options;
      const a = parseFloat(document.getElementById(`input-${fldA}`)?.value) || 0;
      const b = parseFloat(document.getElementById(`input-${fldB}`)?.value) || 0;
      let res = '';
      switch (op) {
        case '+': res = a + b; break;
        case '-': res = a - b; break;
        case '*': res = a * b; break;
        case '/': res = b !== 0 ? a / b : '∞'; break;
      }
      const out = document.getElementById(`formula-${r.id}`);
      if (out) out.textContent = res;
    });
}
function attachFormulaListeners() {
  schemaRows
    .filter(r => !(r.dataType === 'formula' && r.widget === 'formula editor'))
    .forEach(r => {
      const node = document.getElementById(`input-${r.id}`);
      if (!node) return;
      node.removeEventListener('input',  evaluateAllFormulas);
      node.removeEventListener('change', evaluateAllFormulas);
      node.addEventListener('input',  evaluateAllFormulas);
      node.addEventListener('change', evaluateAllFormulas);
    });
}

function attachFormulaListeners() {
  schemaRows
    .filter(r => r.widget !== 'formula editor')
    .forEach(r => {
      const node = document.getElementById(`input-${r.id}`);
      if (!node) return;
      node.removeEventListener('input',  evaluateAllFormulas);
      node.removeEventListener('change', evaluateAllFormulas);
      node.addEventListener('input',  evaluateAllFormulas);
      node.addEventListener('change', evaluateAllFormulas);
    });
}

</script>

</body>
</html>
